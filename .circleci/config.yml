version: 2.1
orbs:
  python: circleci/python@1.1.0

      
jobs:

  install_dependencies:
    machine: true
    resource_class: viplaw-singh/ubuntu-runner
    steps:
      - checkout
      - run: 
          name: "install dependencies"
          command: |
            sudo apt-get update -y 
            sudo apt-get install -y python3
            sudo apt-get install -y python3-pip
            pip  install -r requirements/base.txt
            pip  install -r requirements/local.txt
     
      - run:
          name: "Run migration"
          command: |
            python3 manage.py runserver 127.0.0.1:5432
            python3 manage.py migrate 127.0.0.1:5432
  
  wait_for_test_completion:
    machine: true
    resource_class: viplaw-singh/ubuntu-runner
    steps:
      - checkout
      - run:
          name: Wait for Completion
          command: |
            echo "lambda test completed"    
  build:
    machine: true
    resource_class: viplaw-singh/ubuntu-runner
    steps:
      - checkout
      - run:
          name: "Run Test"
          command: |
            pytest
           
workflows:
  main:
    jobs:
      - install_dependencies
      - wait_for_test_completion:
          requires:
            - install_dependencies
      - build:
          requires:
            - wait_for_test_completion
